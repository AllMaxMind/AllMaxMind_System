name: CI - Quality Gates & Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: "18"
  CACHE_KEY: node-modules-${{ hashFiles('**/package-lock.json') }}

jobs:
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci --verbose

      - name: TypeScript Type Check
        run: npm run typecheck
        if: always()

      - name: ESLint - Code Quality
        run: npm run lint
        if: always()

      - name: Unit Tests
        run: npm test -- --coverage --reporter=json --reporter=default
        if: always()

      - name: Upload Test Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Production Build
        run: npm run build
        if: always()
        env:
          # Use dummy values for build (no secrets needed)
          VITE_GEMINI_API_KEY: "build-placeholder"
          VITE_SUPABASE_URL: "https://placeholder.supabase.co"
          VITE_SUPABASE_ANON_KEY: "build-placeholder"

      - name: Verify Build Artifacts
        run: |
          echo "Checking build output..."
          [ -f "dist/index.html" ] || exit 1
          [ -d "dist/assets" ] || exit 1
          echo "✓ Build artifacts verified"

      - name: Check Bundle Size
        run: |
          BUNDLE_SIZE=$(du -sb dist | cut -f1)
          BUNDLE_SIZE_KB=$((BUNDLE_SIZE / 1024))
          BUNDLE_SIZE_MB=$(echo "scale=2; $BUNDLE_SIZE_KB / 1024" | bc)
          echo "Bundle size: ${BUNDLE_SIZE_MB} MB (${BUNDLE_SIZE_KB} KB)"
          if [ $BUNDLE_SIZE_KB -gt 512000 ]; then
            echo "⚠️  Bundle size exceeds 500KB target!"
            exit 1
          fi
          echo "✓ Bundle size check passed"

      - name: Security Audit
        run: npm audit --audit-level=high
        if: always()
        continue-on-error: true

      - name: Report Quality Summary
        if: always()
        run: |
          echo "## Quality Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✓ TypeScript type checking passed" >> $GITHUB_STEP_SUMMARY
          echo "✓ ESLint code quality passed" >> $GITHUB_STEP_SUMMARY
          echo "✓ Unit tests passed" >> $GITHUB_STEP_SUMMARY
          echo "✓ Production build successful" >> $GITHUB_STEP_SUMMARY
          echo "✓ Bundle size < 500KB" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

  status-check:
    name: Status Check
    runs-on: ubuntu-latest
    needs: quality-checks
    if: always()

    steps:
      - name: Determine Status
        if: failure()
        run: |
          echo "❌ Quality checks failed"
          exit 1

      - name: Success Message
        if: success()
        run: echo "✅ All quality checks passed!"

permissions:
  contents: read
  checks: write
  pull-requests: write
